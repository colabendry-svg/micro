      import React, { useState, useRef, useEffect } from 'react';
      import { Upload, X, FileVideo, Image as ImageIcon, Download, Sparkles, Settings2, AlertCircle, CheckCircle2, FileText, Code2, RefreshCw, Lightbulb, Tag, Copy, ShieldCheck, Palette, AlertTriangle } from 'lucide-react';
      import { GoogleGenerativeAI } from "@google/generative-ai";

// --- KONFIGURASI AI ---
const API_KEY = "";

const MicrostockGenius = () => {
  // --- STATE MANAGEMENT ---
  const [activeTab, setActiveTab] = useState('image'); // 'image' | 'video'
  const [file, setFile] = useState(null);
  const [previewUrl, setPreviewUrl] = useState(null);
  const [isDragOver, setIsDragOver] = useState(false);
  const [loading, setLoading] = useState(false);
  const [generatedPrompts, setGeneratedPrompts] = useState([]);
  const [error, setError] = useState('');
  
  const [brainstormLoading, setBrainstormLoading] = useState(false);
  const [brainstormIdeas, setBrainstormIdeas] = useState(null);
  const [metadataLoading, setMetadataLoading] = useState({});
  const [generatedMetadata, setGeneratedMetadata] = useState({});
  const [safetyLoading, setSafetyLoading] = useState(false);
  const [safetyReport, setSafetyReport] = useState(null);
  const [remixLoading, setRemixLoading] = useState({});

  const [settings, setSettings] = useState({
    language: 'English',
    outputFormat: 'text',
    count: 10
  });

  const videoRef = useRef(null);
  const fileInputRef = useRef(null);

  // --- HANDLERS ---
  const handleFileChange = (selectedFile) => {
    setError('');
    if (!selectedFile) return;

    const validImageTypes = ['image/jpeg', 'image/png', 'image/jpg'];
    const validVideoTypes = ['video/mp4', 'video/quicktime'];

    if (activeTab === 'image') {
      if (!validImageTypes.includes(selectedFile.type)) {
        setError('Format gambar tidak didukung. Gunakan JPG atau PNG.');
        return;
      }
    } else {
      if (!validVideoTypes.includes(selectedFile.type)) {
        setError('Format video tidak didukung. Gunakan MP4 atau MOV.');
        return;
      }
    }

    setFile(selectedFile);
    const url = URL.createObjectURL(selectedFile);
    setPreviewUrl(url);
    // Reset results when new file is uploaded
    setGeneratedPrompts([]);
    setBrainstormIdeas(null);
    setGeneratedMetadata({});
    setSafetyReport(null);
  };

  const onDragOver = (e) => {
    e.preventDefault();
    setIsDragOver(true);
  };

  const onDragLeave = () => {
    setIsDragOver(false);
  };

  const onDrop = (e) => {
    e.preventDefault();
    setIsDragOver(false);
    if (e.dataTransfer.files && e.dataTransfer.files[0]) {
      handleFileChange(e.dataTransfer.files[0]);
    }
  };

  const clearAll = () => {
    setFile(null);
    setPreviewUrl(null);
    setGeneratedPrompts([]);
    setBrainstormIdeas(null);
    setGeneratedMetadata({});
    setSafetyReport(null);
    setError('');
    if (fileInputRef.current) fileInputRef.current.value = '';
  };

  // --- AI LOGIC (Sama seperti sebelumnya namun tetap dipertahankan) ---
  const fileToGenerativePart = async (file) => {
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result.split(',')[1]);
      reader.readAsDataURL(file);
    });
  };

  const captureVideoFrame = () => {
    return new Promise((resolve, reject) => {
      const video = videoRef.current;
      if (!video) return reject("Video element not found");
      const canvas = document.createElement("canvas");
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
      resolve(canvas.toDataURL("image/jpeg").split(',')[1]);
    });
  };

  const getModel = (jsonMode = true) => {
    const genAI = new GoogleGenerativeAI(API_KEY);
    return genAI.getGenerativeModel({ 
      model: "gemini-2.5-flash-preview-09-2025",
      generationConfig: { responseMimeType: jsonMode ? "application/json" : "text/plain" }
    });
  };

  const generatePrompts = async () => {
    if (!file) return;
    setLoading(true);
    setError('');
    try {
      const model = getModel(true);
      let imagePart;
      if (activeTab === 'image') {
        const base64Data = await fileToGenerativePart(file);
        imagePart = { inlineData: { data: base64Data, mimeType: file.type } };
      } else {
        const base64Data = await captureVideoFrame();
        imagePart = { inlineData: { data: base64Data, mimeType: "image/jpeg" } };
      }

      const systemPrompt = `Analyze the provided media and generate ${settings.count} high-quality commercial microstock prompts. Language: ${settings.language}. NO brands/IP. Output JSON: { "prompts": [{ "id": number, "full_prompt": string, "details": { "subject": string, "mood": string, "style": string } }] }`;
      const result = await model.generateContent([systemPrompt, imagePart]);
      const parsedData = JSON.parse(result.response.text());
      setGeneratedPrompts(parsedData.prompts || []);
    } catch (err) {
      setError('Gagal menghasilkan prompt. Silakan coba lagi.');
    } finally {
      setLoading(false);
    }
  };

  const generateMetadata = async (id, promptText) => {
    setMetadataLoading(p => ({...p, [id]: true}));
    try {
      const model = getModel(true);
      const res = await model.generateContent(`Generate microstock SEO title and 50 keywords for: "${promptText}". JSON: { "title": "string", "keywords": "string" }`);
      setGeneratedMetadata(p => ({...p, [id]: JSON.parse(res.response.text())}));
    } finally { setMetadataLoading(p => ({...p, [id]: false})); }
  };

  const generateBrainstormIdeas = async () => {
    setBrainstormLoading(true);
    try {
      const model = getModel(true);
      const base64 = activeTab === 'image' ? await fileToGenerativePart(file) : await captureVideoFrame();
      const res = await model.generateContent([{ inlineData: { data: base64, mimeType: "image/jpeg" } }, "Suggest 3 alternative concepts. JSON: { \"ideas\": [{ \"title\": \"string\", \"description\": \"string\" }] }"]);
      setBrainstormIdeas(JSON.parse(res.response.text()).ideas);
    } finally { setBrainstormLoading(false); }
  };

  const analyzeSafety = async () => {
    setSafetyLoading(true);
    try {
      const model = getModel(true);
      const base64 = activeTab === 'image' ? await fileToGenerativePart(file) : await captureVideoFrame();
      const res = await model.generateContent([{ inlineData: { data: base64, mimeType: "image/jpeg" } }, "Audit for microstock IP risks. JSON: { \"status\": \"SAFE/CAUTION\", \"reasons\": [], \"model_release_needed\": bool, \"property_release_needed\": bool }"]);
      setSafetyReport(JSON.parse(res.response.text()));
    } finally { setSafetyLoading(false); }
  };

  const remixPrompt = async (id, current, style) => {
    setRemixLoading(p => ({...p, [id]: true}));
    try {
      const model = getModel(true);
      const res = await model.generateContent(`Rewrite this prompt in ${style} style: "${current}". JSON: { "remixed_prompt": "string" }`);
      const newText = JSON.parse(res.response.text()).remixed_prompt;
      setGeneratedPrompts(prev => prev.map(p => p.id === id ? {...p, full_prompt: newText} : p));
    } finally { setRemixLoading(p => ({...p, [id]: false})); }
  };

  const downloadCSV = () => {
    let csv = "data:text/csv;charset=utf-8,No,Prompt\n";
    generatedPrompts.forEach(p => csv += `${p.id},"${p.full_prompt.replace(/"/g, '""')}"\n`);
    const link = document.createElement("a");
    link.href = encodeURI(csv);
    link.download = `prompts_${Date.now()}.csv`;
    link.click();
  };

  return (
    <div className="min-h-screen bg-[#0a0514] text-gray-100 font-sans p-4 md:p-8 flex items-center justify-center relative overflow-hidden">
      
      {/* Ambience Layers */}
      <div className="fixed top-[-10%] left-[-5%] w-[400px] h-[400px] bg-purple-600/10 rounded-full blur-[100px] pointer-events-none" />
      <div className="fixed bottom-[-10%] right-[-5%] w-[400px] h-[400px] bg-pink-600/10 rounded-full blur-[100px] pointer-events-none" />

      {/* Main Container */}
      <div className="w-full max-w-5xl bg-[#160d2b]/60 backdrop-blur-2xl border border-purple-500/20 rounded-[2.5rem] shadow-[0_0_60px_rgba(139,92,246,0.1)] p-6 md:p-10 flex flex-col md:flex-row gap-10 relative z-10">
        
        {/* LEFT: Upload & Preview */}
        <div className="flex-1 flex flex-col gap-6">
          <div className="space-y-1">
            <h1 className="text-2xl font-bold tracking-tight">Microstock<span className="text-purple-400">Genius</span></h1>
            <p className="text-xs text-gray-500 font-medium">Tool AI Premium untuk Kontributor Foto & Video</p>
          </div>

          {/* Mode Switcher */}
          <div className="flex bg-black/40 p-1 rounded-2xl border border-white/5">
            <button
              onClick={() => { setActiveTab('image'); clearAll(); }}
              className={`flex-1 flex items-center justify-center gap-2 py-3 rounded-xl text-xs font-bold transition-all ${
                activeTab === 'image' ? 'bg-purple-600 text-white shadow-lg' : 'text-gray-500 hover:text-gray-300'
              }`}
            >
              <ImageIcon className="w-4 h-4" /> Gambar
            </button>
            <button
              onClick={() => { setActiveTab('video'); clearAll(); }}
              className={`flex-1 flex items-center justify-center gap-2 py-3 rounded-xl text-xs font-bold transition-all ${
                activeTab === 'video' ? 'bg-purple-600 text-white shadow-lg' : 'text-gray-500 hover:text-gray-300'
              }`}
            >
              <FileVideo className="w-4 h-4" /> Video
            </button>
          </div>

          {/* DRAG & DROP AREA */}
          <div 
            onDragOver={onDragOver}
            onDragLeave={onDragLeave}
            onDrop={onDrop}
            onClick={() => !previewUrl && fileInputRef.current.click()}
            className={`relative min-h-[320px] rounded-[2rem] border-2 border-dashed transition-all flex flex-col items-center justify-center cursor-pointer overflow-hidden ${
              previewUrl ? 'border-purple-500/50 bg-black/40' : 
              isDragOver ? 'border-purple-400 bg-purple-500/20 scale-[1.02] shadow-[0_0_30px_rgba(168,85,247,0.3)]' : 
              'border-purple-500/20 bg-black/20 hover:border-purple-500/40 hover:bg-black/30'
            }`}
          >
            {previewUrl ? (
              <div className="w-full h-full p-4 relative group">
                {activeTab === 'image' ? (
                  <img src={previewUrl} className="w-full h-full object-contain rounded-xl" alt="Preview" />
                ) : (
                  <video ref={videoRef} src={previewUrl} controls className="w-full h-full object-contain rounded-xl" />
                )}
                <button 
                  onClick={(e) => { e.stopPropagation(); clearAll(); }}
                  className="absolute top-6 right-6 p-2 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity shadow-lg"
                >
                  <X className="w-4 h-4" />
                </button>
              </div>
            ) : (
              <div className="text-center p-10 animate-in fade-in zoom-in duration-300">
                <div className={`w-20 h-20 rounded-3xl bg-purple-500/10 flex items-center justify-center mx-auto mb-6 border border-purple-500/20 ${isDragOver ? 'animate-bounce' : ''}`}>
                  <Upload className="w-10 h-10 text-purple-400" />
                </div>
                <h3 className="text-white font-bold text-lg mb-2">Tarik & Lepas File Di Sini</h3>
                <p className="text-gray-500 text-xs mb-6 max-w-[200px] mx-auto leading-relaxed">
                  {activeTab === 'image' ? 'Mendukung JPG, JPEG, atau PNG' : 'Mendukung MP4 atau MOV'}
                </p>
                <div className="px-8 py-3 bg-purple-600 hover:bg-purple-500 text-white text-xs font-bold rounded-full transition-all shadow-lg">
                  Pilih File Manual
                </div>
              </div>
            )}
            <input 
              type="file" 
              ref={fileInputRef}
              className="hidden"
              onChange={(e) => handleFileChange(e.target.files[0])}
              accept={activeTab === 'image' ? "image/*" : "video/*"}
            />
          </div>

          {/* Quick Actions */}
          {file && !loading && (
             <div className="grid grid-cols-2 gap-3 animate-in slide-in-from-bottom-2">
                <button onClick={generateBrainstormIdeas} disabled={brainstormLoading} className="py-3 bg-white/5 hover:bg-white/10 rounded-2xl text-[10px] font-bold uppercase tracking-wider text-purple-300 border border-white/5 flex items-center justify-center gap-2">
                  {brainstormLoading ? <RefreshCw className="w-3 h-3 animate-spin" /> : <Lightbulb className="w-3 h-3" />} Ide Variasi
                </button>
                <button onClick={analyzeSafety} disabled={safetyLoading} className="py-3 bg-white/5 hover:bg-white/10 rounded-2xl text-[10px] font-bold uppercase tracking-wider text-blue-300 border border-white/5 flex items-center justify-center gap-2">
                  {safetyLoading ? <RefreshCw className="w-3 h-3 animate-spin" /> : <ShieldCheck className="w-3 h-3" />} Cek Hak Cipta
                </button>
             </div>
          )}
          
          {/* Analysis Results */}
          <div className="space-y-3">
            {brainstormIdeas && (
              <div className="p-4 bg-purple-500/10 border border-purple-500/20 rounded-2xl animate-in fade-in">
                <h4 className="text-[10px] font-black uppercase text-purple-400 mb-3 flex items-center gap-2"><Sparkles className="w-3 h-3"/> Konsep Alternatif</h4>
                <div className="space-y-2">
                  {brainstormIdeas.map((idea, i) => <div key={i} className="text-[10px] text-gray-300 bg-black/20 p-2 rounded-lg border border-white/5"><strong>{idea.title}:</strong> {idea.description}</div>)}
                </div>
              </div>
            )}
            {safetyReport && (
              <div className={`p-4 border rounded-2xl animate-in fade-in ${safetyReport.status === 'SAFE' ? 'bg-green-500/10 border-green-500/20 text-green-400' : 'bg-orange-500/10 border-orange-500/20 text-orange-400'}`}>
                <h4 className="text-[10px] font-black uppercase mb-2 flex items-center gap-2">
                  {safetyReport.status === 'SAFE' ? <CheckCircle2 className="w-3 h-3"/> : <AlertTriangle className="w-3 h-3"/>} 
                  Status Keamanan: {safetyReport.status}
                </h4>
                <ul className="text-[10px] list-disc list-inside opacity-80">{safetyReport.reasons.map((r, i) => <li key={i}>{r}</li>)}</ul>
              </div>
            )}
          </div>
        </div>

        {/* RIGHT: Settings & Generation */}
        <div className="flex-1 flex flex-col gap-6">
          <div className="bg-black/40 rounded-[2rem] p-8 border border-white/5 space-y-8">
            <div className="flex items-center gap-3 text-white">
              <Settings2 className="w-5 h-5 text-purple-400" />
              <h2 className="font-bold text-sm tracking-wide">Pengaturan Output</h2>
            </div>

            <div className="space-y-6">
              <div className="space-y-3">
                <label className="text-[10px] font-black uppercase tracking-widest text-gray-500">Bahasa</label>
                <select value={settings.language} onChange={e => setSettings({...settings, language: e.target.value})} className="w-full bg-black/60 border border-white/10 rounded-xl px-4 py-3 text-xs outline-none focus:border-purple-500 transition-all">
                  <option value="English">English (Global)</option>
                  <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                </select>
              </div>

              <div className="space-y-3">
                <label className="text-[10px] font-black uppercase tracking-widest text-gray-500">Format Prompt</label>
                <div className="flex bg-black/60 p-1 rounded-xl border border-white/10">
                  <button onClick={() => setSettings({...settings, outputFormat: 'text'})} className={`flex-1 py-2 text-[10px] font-bold rounded-lg transition-all ${settings.outputFormat === 'text' ? 'bg-purple-600 text-white shadow-lg' : 'text-gray-500'}`}>TEKS</button>
                  <button onClick={() => setSettings({...settings, outputFormat: 'json'})} className={`flex-1 py-2 text-[10px] font-bold rounded-lg transition-all ${settings.outputFormat === 'json' ? 'bg-purple-600 text-white shadow-lg' : 'text-gray-500'}`}>JSON</button>
                </div>
              </div>

              <div className="space-y-4">
                <div className="flex justify-between items-center">
                  <label className="text-[10px] font-black uppercase tracking-widest text-gray-500">Jumlah Prompt</label>
                  <span className="text-xs font-bold text-purple-400">{settings.count}</span>
                </div>
                <input type="range" min="1" max="50" value={settings.count} onChange={e => setSettings({...settings, count: parseInt(e.target.value)})} className="w-full h-1.5 bg-gray-800 rounded-lg appearance-none cursor-pointer accent-purple-500" />
              </div>
            </div>
          </div>

          <button
            onClick={generatePrompts}
            disabled={!file || loading}
            className={`w-full py-5 rounded-full font-black text-xs uppercase tracking-widest flex items-center justify-center gap-3 transition-all ${
              !file || loading ? 'bg-gray-800 text-gray-600 cursor-not-allowed' : 'bg-gradient-to-r from-purple-600 to-pink-600 text-white shadow-[0_0_30px_rgba(168,85,247,0.2)] hover:scale-[1.02] active:scale-[0.98]'
            }`}
          >
            {loading ? <><RefreshCw className="w-4 h-4 animate-spin" /> Generating...</> : <><Sparkles className="w-4 h-4" /> Hasilkan Prompt</>}
          </button>

          {/* Results List */}
          {generatedPrompts.length > 0 && (
            <div className="mt-4 space-y-4 animate-in fade-in slide-in-from-right-4 duration-500">
               <div className="flex justify-between items-center px-2">
                 <h3 className="text-[10px] font-black text-purple-400 uppercase tracking-widest">Daftar Prompt</h3>
                 <button onClick={downloadCSV} className="text-[10px] font-bold text-gray-400 hover:text-white flex items-center gap-1 transition-colors"><Download className="w-3 h-3"/> CSV</button>
               </div>
               <div className="max-h-[400px] overflow-y-auto pr-2 space-y-3 custom-scrollbar">
                 {generatedPrompts.map(p => (
                   <div key={p.id} className="bg-black/40 border border-white/5 p-4 rounded-2xl group hover:border-purple-500/30 transition-all">
                      <div className="flex justify-between mb-2">
                        <span className="text-[9px] font-black text-gray-600 tracking-tighter">#{p.id}</span>
                        <div className="flex gap-2">
                          <button onClick={() => {navigator.clipboard.writeText(p.full_prompt);}} className="text-[9px] font-bold text-purple-400 uppercase tracking-tighter bg-purple-400/10 px-2 py-1 rounded hover:bg-purple-400/20">Copy</button>
                        </div>
                      </div>
                      <p className="text-[11px] text-gray-300 leading-relaxed mb-4">{p.full_prompt}</p>
                      <div className="flex flex-wrap gap-2 pt-3 border-t border-white/5">
                        {!generatedMetadata[p.id] ? (
                          <button onClick={() => generateMetadata(p.id, p.full_prompt)} disabled={metadataLoading[p.id]} className="text-[9px] font-bold text-gray-500 hover:text-purple-400 flex items-center gap-1">
                            {metadataLoading[p.id] ? <RefreshCw className="w-2 h-2 animate-spin" /> : <Tag className="w-2 h-2" />} Get Metadata
                          </button>
                        ) : (
                          <div className="w-full text-[9px] text-gray-500 space-y-1">
                            <div className="line-clamp-1"><span className="text-purple-400/60 font-bold">TITLE:</span> {generatedMetadata[p.id].title}</div>
                            <div className="line-clamp-1"><span className="text-purple-400/60 font-bold">TAGS:</span> {generatedMetadata[p.id].keywords}</div>
                          </div>
                        )}
                        <div className="w-full flex gap-2 mt-1">
                          {['Cinematic', 'Vivid'].map(s => <button key={s} onClick={() => remixPrompt(p.id, p.full_prompt, s)} className="text-[8px] bg-white/5 px-2 py-1 rounded text-gray-500 hover:text-pink-400">{s} Remix</button>)}
                        </div>
                      </div>
                   </div>
                 ))}
               </div>
            </div>
          )}
        </div>
      </div>

      <style>{`
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(139, 92, 246, 0.2); border-radius: 10px; }
        @keyframes bounce-slow { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
      `}</style>
    </div>
  );
};

export default MicrostockGenius;
